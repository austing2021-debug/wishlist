<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âšœï¸ æ”¶è—æ¸…å–® âšœï¸</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700&family=Noto+Sans+TC:wght@300;400&display=swap" rel="stylesheet">
    <style>
        /* --- 1. é…è‰²ç³»çµ± --- */
        :root {
            /* æ¢ä»¶1: èƒŒæ™¯æ¥µæ·ºï¼Œåç™½ */
            --bg-page: #FDFDFD;           
            
            /* é¢æ¿åŸºåº• */
            --bg-panel: #EAEAEA;          
            
            /* æ¢ä»¶3: è¼¸å…¥æ¡†é¡è‰²æŒ‡å®šç‚º #FCFAF1 */
            --bg-input: #FCFAF1;          
            
            /* æ–‡å­—é¡è‰² */
            --text-main: #000000;         /* ä¸»è¦æ–‡å­—ç´”é»‘ */
            --text-label: #000000;        /* æ¢ä»¶4: æ¨™ç±¤æ–‡å­—å…¨é»‘ */
            
            /* åŠŸèƒ½è‰² */
            --color-primary: #0D5498;     /* æ·±æµ·è— */
            --color-accent: #837791;      /* ç´«ç° */
            --color-danger: #B86B6B;      /* è«è˜­è¿ªç´… */
            
            /* æ¢ä»¶5, 6, 9: è—ç³»æŒ‰éˆ•æŒ‰ä¸‹è‰² */
            --active-blue: #CFDDEA;       
            
            /* æ¢ä»¶10: ç´…ç³»æŒ‰éˆ•æŒ‰ä¸‹è‰² */
            --active-red: #FFDCE3;        

            /* æ¢ä»¶15: åœ–ç‰‡æŒ‡å®šæ–°å¢æŒ‰éˆ•è‰² */
            --btn-add-bg: #668BC4; 
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: var(--bg-page); 
            color: var(--text-main);
            padding: 15px;
            max-width: 900px; 
            margin: 0 auto; 
            padding-bottom: 100px; 
        }

        h1 { 
            font-family: 'Noto Serif TC', serif; 
            color: var(--text-main); 
            margin: 0; letter-spacing: 2px; font-size: 22px; text-align: center;
        }

        .header-row { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }

        /* --- UI å…ƒä»¶æ¨£å¼ --- */

        /* æ¢ä»¶2: é¢æ¿æ¨£å¼ - å·¦ä¸Šç„¡ç™½å…‰ï¼Œæ”¹é›™é‡é™°å½±å¼·èª¿3Dæµ®å‡º */
        .panel-container {
            padding: 20px; border-radius: 20px; 
            background-color: var(--bg-panel);
            /* é—œéµï¼šä½¿ç”¨åŠé€æ˜é»‘å½±æ¨¡æ“¬æµ®èµ·æ•ˆæœ */
            box-shadow: 8px 8px 16px rgba(0,0,0,0.12), -4px -4px 12px rgba(0,0,0,0.03);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.4); 
        }

        /* æ¢ä»¶3: è¼¸å…¥æ¡†é¡è‰² #FCFAF1 */
        .sunken-input {
            background: var(--bg-input); 
            border: none; border-radius: 10px;
            padding: 0 12px; width: 100%; box-sizing: border-box; 
            color: var(--text-main); font-size: 14px; outline: none;
            /* å…§é™°å½±ä¿æŒç«‹é«”æ„Ÿ */
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
            transition: 0.1s; height: 42px;
        }
        .sunken-input::placeholder { color: #888; }
        .sunken-input:focus { background: #FFF; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.15); }

        /* å‡¸èµ·æŒ‰éˆ• (é€šç”¨) */
        .convex-btn {
            background: var(--bg-panel); 
            color: var(--text-main); 
            border: none;
            padding: 8px 12px; border-radius: 12px; cursor: pointer;
            font-weight: bold; letter-spacing: 1px; font-size: 13px;
            /* æµ®å‡ºé™°å½± */
            box-shadow: 4px 4px 8px rgba(0,0,0,0.15), -3px -3px 6px rgba(255,255,255,0.8);
            transition: all 0.1s ease;
            display: flex; align-items: center; justify-content: center;
            height: 42px; box-sizing: border-box;
        }
        /* æ¢ä»¶6: ä¸­é–“äº”å¤§æŒ‰éˆ•æŒ‰ä¸‹è®Šè‰² #CFDDEAï¼Œæ–‡å­—ä¿æŒé»‘è‰² */
        .convex-btn:active, .convex-btn.active {
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
            transform: translateY(1px);
            background-color: var(--active-blue) !important;
            color: black !important;
        }

        /* æ¢ä»¶5: æŠ“å–æŒ‰éˆ• (å…¨é»‘å­—) */
        .btn-fetch { color: black; }
        .btn-fetch:active { background-color: var(--active-blue); }

        /* æ¢ä»¶9: é‡ç½®æŒ‰éˆ• (å…¨é»‘å­—, æŒ‰ä¸‹è®Šè‰²) */
        .action-btn-reset { color: black; }
        .action-btn-reset:active { background-color: var(--active-blue); }

        /* æ¢ä»¶10: ç™»å‡ºèˆ‡é‡æ•´æŒ‰éˆ• (è«è˜­è¿ªç´…å­—, æŒ‰ä¸‹è®Šç²‰ç´… #FFDCE3) */
        .btn-danger-style { 
            color: var(--color-danger); 
            font-weight: bold;
        }
        .btn-danger-style:active { 
            background-color: var(--active-red) !important; 
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
        }

        .btn-full { width: 100%; }
        
        .search-container { margin-bottom: 20px; }

        /* åˆ†é¡æŒ‰éˆ•çµ„ */
        .category-group { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 15px; }
        .cat-btn-layout { flex-direction: column; gap: 5px; padding: 8px 2px; height: auto; min-height: 60px; }
        .cat-icon { width: 24px; height: 24px; }
        .cat-text { font-size: 11px; white-space: nowrap; color: black; } 

        /* æ¢ä»¶4: è¡¨æ ¼ä¸Šæ–¹æ–‡å­—ä»‹ç´¹æ”¹é»‘è‰² */
        .input-group { margin-bottom: 15px; width: 100%; }
        .input-label { 
            font-size: 12px; color: black; 
            margin-left: 5px; margin-bottom: 4px; display: block; font-weight: bold; 
        }
        .input-row-multi { display: flex; gap: 10px; width: 100%; align-items: flex-end; }

        .platform-wrapper { display: flex; gap: 5px; width: 100%; }
        .platform-select { flex-grow: 1; } 
        .platform-other { display: none; width: 50%; }
        .platform-other.show { display: block; }

        .img-preview-box {
            width: 100%; min-height: 50px; border-radius: 12px; margin-top: 10px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
            overflow: hidden; display: none; align-items: center; justify-content: center;
            padding: 10px; box-sizing: border-box; background: var(--bg-input);
        }
        .img-preview-box.has-img { display: flex; }
        .img-preview-content { max-width: 100%; max-height: 200px; object-fit: contain; }

        /* æ¢ä»¶13: åœ°åœ–æŒ‰éˆ•æ”¹å–®è‰²SVG */
        .btn-map-convert {
            width: 42px; height: 42px; border-radius: 12px; background: var(--bg-panel); border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 4px 4px 8px rgba(0,0,0,0.15), -3px -3px 6px rgba(255,255,255,0.8);
            flex-shrink: 0;
        }
        .btn-map-convert svg { width: 18px; height: 18px; fill: var(--color-primary); }
        .btn-map-convert:active { 
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); transform: scale(0.95); 
            background-color: var(--active-blue);
        }

        /* ------------------------------------------- */
        /* --- ç¯©é¸èˆ‡æœå°‹ --- */
        /* ------------------------------------------- */
        .filter-wrapper { margin-bottom: 25px; }

        .filter-search-box {
            background: var(--bg-panel); border: none; border-radius: 12px;
            color: var(--text-main); font-size: 14px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.15), -2px -2px 5px rgba(255,255,255,0.8);
            outline: none; padding: 0 15px; display: flex; align-items: center;
        }
        .filter-search-box::placeholder { text-align:center; color:#777; }
        
        .filter-select {
            background: var(--bg-panel); border: none; border-radius: 10px; padding: 0 10px;
            color: var(--text-main); font-size: 12px; 
            box-shadow: 3px 3px 6px rgba(0,0,0,0.15), -2px -2px 5px rgba(255,255,255,0.8);
            outline: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right .5em center; background-size: 1em;
        }
        /* æ¢ä»¶11: ç¯©é¸è¡¨æŒ‰ä¸‹å»åæ‡‰ */
        .filter-select:active, .filter-select:focus {
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
        }

        /* æ¢ä»¶10: â†º æŒ‰ä¸‹è®Šè‰² #FFDCE3 */
        .filter-reset-btn {
            background: var(--bg-panel); color: var(--color-danger); border: none; 
            border-radius: 12px; 
            box-shadow: 3px 3px 6px rgba(0,0,0,0.15), -2px -2px 5px rgba(255,255,255,0.8);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: bold;
        }
        .filter-reset-btn:active { 
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); 
            background-color: var(--active-red);
        }

        /* é›»è…¦ç‰ˆ layout (3.1) */
        @media(min-width: 650px) {
            .filter-wrapper { display: flex; flex-direction: row; gap: 10px; height: 42px; align-items: center; }
            .filter-search-box { width: 200px; height: 100%; } /* å·¦å³å¯¬ */
            .filter-select-container { flex: 1; display: flex; gap: 8px; height: 100%; }
            .filter-select { flex: 1; height: 100%; }
            .filter-reset-btn { width: 60px; height: 100%; }
        }

        /* æ‰‹æ©Ÿç‰ˆ layout (3.2 & 14) */
        @media(max-width: 649px) {
            .filter-wrapper { display: flex; flex-direction: column; gap: 10px; }
            
            /* æ¢ä»¶14: æœå°‹èˆ‡é‡ç½®æŒ‰éˆ•ä¸¦æ’ */
            .filter-top-row { display: flex; gap: 10px; width: 100%; height: 48px; }
            .filter-search-box { flex: 1; height: 100%; } /* ä¸Šä¸‹å¯¬(é«˜) */
            .filter-reset-btn { width: 50px; height: 100%; }

            .filter-select-container { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px; }
            .filter-select { width: 100%; height: 45px; } /* æ‹‰å¤§ */
        }

        /* ------------------------------------------- */

        .grid-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 20px; padding-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .grid-container::-webkit-scrollbar { display: none; }
        @media(min-width: 650px) { .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); overflow-x: visible; justify-items: center; } }

        .card { 
            width: 280px; height: 430px; flex-shrink: 0; scroll-snap-align: center;
            background: var(--bg-panel); border-radius: 20px; overflow: hidden; 
            box-shadow: 6px 6px 12px rgba(0,0,0,0.15), -4px -4px 10px rgba(255,255,255,0.8);
            display: flex; flex-direction: column;
        }
        /* æ¢ä»¶12: é»æ“Šåœ–ç‰‡è¦æœ‰"æŒ‰ä¸‹å»"åæ‡‰ï¼Œé™°å½±è¦†è“‹ */
        .card-img-wrapper {
            width: 90%; margin: 15px auto 0 auto; height: 160px; border-radius: 15px; overflow: hidden;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.15), -3px -3px 6px rgba(255,255,255,0.8);
            background: var(--bg-input); display: flex; align-items: center; justify-content: center;
            transition: 0.1s; position: relative;
        }
        .card-img-wrapper:active {
            transform: scale(0.98);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
        }
        .card-img-wrapper:active::after {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.1); pointer-events: none;
        }

        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .no-img-box { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 14px;}

        .card-body { padding: 15px; display: flex; flex-direction: column; flex: 1; }
        .card-meta-row { display: flex; gap: 6px; margin-bottom: 10px; justify-content: center; }
        .meta-box {
            width: 23%; font-size: 11px; color: #555; text-align: center;
            padding: 4px 0; border-radius: 8px; background: var(--bg-panel);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .card-title { font-size: 20px; color: var(--text-main); font-weight: bold; margin-bottom: 5px; line-height: 1.3; max-height: 52px; overflow: hidden; }
        .card-feature { font-size: 13px; color: var(--color-primary); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .card-btn-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: auto; padding-top: 10px; }
        .btn-mini { 
            padding: 6px 12px; font-size: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold;
            background: var(--bg-panel); box-shadow: 2px 2px 4px rgba(0,0,0,0.15);
        }
        .btn-mini:active { box-shadow: inset 2px 2px 4px rgba(0,0,0,0.15); transform: translateY(1px); }
        .btn-edit { color: var(--color-accent); }
        .btn-del { color: var(--color-danger); }
        
        .btn-map-icon { width: 16px; height: 16px; fill: var(--color-primary); margin-top:2px;}

        .action-row { display: flex; gap: 10px; margin-top: 20px; align-items: stretch; }
        
        /* åœ–ç‰‡æŒ‡å®šæ–°å¢æŒ‰éˆ•é…è‰² */
        .action-btn-add { flex: 2; background-color: var(--btn-add-bg); color: black; } 
        .action-btn-add:active { background-color: var(--active-blue); }
        
        .action-btn-edit { flex: 2; color: var(--color-accent); }
        .action-btn-edit:active { background-color: var(--active-blue); }
        
        .action-btn-reset { flex: 1; color: black; }
        .action-btn-reset:active { background-color: var(--active-blue); }
        
        /* æ¢ä»¶2: ç™»å‡ºæ–‡å­—è®Šæ–¹æ¡† (åŒæŒ‰éˆ•æ¨£å¼) */
        .action-btn-logout { 
            flex: 0 0 60px; 
            background: var(--bg-panel); border: none;
            color: var(--color-danger); font-size: 13px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            border-radius: 12px; cursor: pointer;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.15), -3px -3px 6px rgba(255,255,255,0.8);
        }
        .action-btn-logout:active { 
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); 
            background-color: var(--active-red); 
        }

        /* ç™»å…¥é®ç½© */
        .auth-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--text-main); }
        #auth-msg { margin-top: 10px; font-size: 13px; }

        /* Map & Picker */
        #map-overlay, #picker-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-page); z-index: 2000; display: none; flex-direction: column; }
        #map-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 2001; }
        #full-map, #picker-map { flex: 1; width: 100%; }
        #picker-container { width: 90%; height: 70%; background: white; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        
        .marker-pin { 
            width: 34px; height: 34px; border-radius: 50% 50% 50% 0; 
            background: #333; 
            position: absolute; transform: rotate(-45deg); 
            left: 50%; top: 50%; margin: -15px 0 0 -15px; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); border: 2px solid white; 
        }
        .marker-pin img { transform: rotate(45deg); width: 18px; height: 18px; filter: brightness(0) invert(1); }

        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; }
        .fab-btn {
            width: 50px; height: 50px; border-radius: 50%; background: var(--bg-panel);
            border: none; cursor: pointer; box-shadow: 5px 5px 10px rgba(0,0,0,0.15), -3px -3px 8px rgba(255,255,255,0.8);
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        /* æ¢ä»¶15: FAB SVG å–®è‰² (æ·±è—) */
        .fab-btn svg { width: 24px; height: 24px; fill: var(--color-primary); }
        .fab-btn:active { box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); transform: scale(0.95); background: var(--active-blue); }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box panel-container"> 
            <div class="auth-title">è«‹å…ˆç™»å…¥</div>
            <input type="text" id="auth-username" class="sunken-input auth-input" placeholder="å¸³è™Ÿ (5-10ç¢¼è‹±æ–‡æ•¸å­—)" maxlength="10" style="margin-bottom:15px; text-align:left;">
            <input type="password" id="auth-pwd" class="sunken-input auth-input" placeholder="å¯†ç¢¼ (è‡³å°‘6ç¢¼)" style="margin-bottom:20px; text-align:left;">
            <button id="btn-login" class="convex-btn btn-full" style="margin-bottom:10px;" onclick="handleLogin()">ç™»å…¥</button>
            <button id="btn-signup" class="convex-btn btn-full" style="color: var(--color-primary);" onclick="handleSignup()">è¨»å†Šæ–°å¸³è™Ÿ</button>
            <p id="auth-msg" style="color:var(--color-danger);"></p>
        </div>
    </div>

    <div class="header-row">
        <h1>âšœï¸ æ”¶è—æ¸…å–® âšœï¸</h1>
    </div>

    <div id="section-add" class="panel-container">
        
        <div class="search-container">
            <div style="display:flex; gap:10px;">
                <input type="text" id="add-link-fetch" class="sunken-input" placeholder="ğŸ”— ç¶²å€æŠ“å–">
                <button class="convex-btn btn-fetch" style="width:80px;" onclick="autoFetch('add')">æŠ“å–</button>
            </div>
        </div>

        <div class="category-group">
            <button class="convex-btn cat-btn-layout cat-btn-add active" onclick="selectCategory('add', 'è³¼ç‰©', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z'%3E%3C/path%3E%3Cline x1='3' y1='6' x2='21' y2='6'%3E%3C/line%3E%3Cpath d='M16 10a4 4 0 0 1-8 0'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">è³¼ç‰©</span>
            </button>
            <button class="convex-btn cat-btn-layout cat-btn-add" onclick="selectCategory('add', 'é¤å»³', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'%3E%3C/path%3E%3Cpath d='M7 2v20'%3E%3C/path%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">é¤å»³</span>
            </button>
            <button class="convex-btn cat-btn-layout cat-btn-add" onclick="selectCategory('add', 'æ™¯é»', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='2' y1='12' x2='22' y2='12'%3E%3C/line%3E%3Cpath d='M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">æ™¯é»</span>
            </button>
            <button class="convex-btn cat-btn-layout cat-btn-add" onclick="selectCategory('add', 'æ—…é¤¨', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 22h20'%3E%3C/path%3E%3Cpath d='M4 22V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v18'%3E%3C/path%3E%3Cpath d='M12 18v4'%3E%3C/path%3E%3Cpath d='M8 6h.01'%3E%3C/path%3E%3Cpath d='M16 6h.01'%3E%3C/path%3E%3Cpath d='M8 10h.01'%3E%3C/path%3E%3Cpath d='M16 10h.01'%3E%3C/path%3E%3Cpath d='M8 14h.01'%3E%3C/path%3E%3Cpath d='M16 14h.01'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">æ—…é¤¨</span>
            </button>
            <button class="convex-btn cat-btn-layout cat-btn-add" onclick="selectCategory('add', 'å…¶ä»–', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">å…¶ä»–</span>
            </button>
        </div>
        <input type="hidden" id="add-category" value="è³¼ç‰©">

        <div class="input-group">
            <span class="input-label">ä¸»é¡Œåç¨±</span>
            <input type="text" id="add-title" class="sunken-input" placeholder="è¼¸å…¥åç¨±" maxlength="25">
        </div>

        <div class="input-group">
            <span class="input-label">åœ–ç‰‡ç¶²å€</span>
            <input type="text" id="add-img" class="sunken-input" placeholder="åœ–ç‰‡é€£çµ" oninput="updatePreview('add')">
            <div id="box-preview-add" class="img-preview-box">
                <img id="preview-add" src="" class="img-preview-content">
            </div>
        </div>

        <div class="input-row-multi">
            <div class="input-group" style="width: 30%;">
                <span class="input-label">åœ‹å®¶</span>
                <input type="text" id="add-country" class="sunken-input" placeholder="" maxlength="10">
            </div>
            <div class="input-group" style="width: 30%;">
                <span class="input-label">éƒ½å¸‚</span>
                <input type="text" id="add-city" class="sunken-input" placeholder="" maxlength="10">
            </div>
            <div class="input-group" style="width: 40%;">
                <span class="input-label">å¹³å°</span>
                <div class="platform-wrapper">
                    <select id="add-platform" class="sunken-input platform-select" onchange="toggleOtherInput('add')">
                        <option value="">(ç„¡)</option>
                        <option value="å®˜ç¶²">å®˜ç¶²</option>
                        <option value="å¯¦é«”">å¯¦é«”</option>
                        <option value="è¦çš®">è¦çš®</option>
                        <option value="momo">momo</option>
                        <option value="æ·˜å¯¶">æ·˜å¯¶</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <input type="text" id="add-platform-other" class="sunken-input platform-other" placeholder="è¼¸å…¥" maxlength="5">
                </div>
            </div>
        </div>
        
        <div class="input-group">
            <span class="input-label">è©³ç´°åœ°å€ / åº§æ¨™</span>
            <div style="display:flex; gap:5px; width:100%;">
                <input type="text" id="add-loc" class="sunken-input" style="flex:3;" placeholder="ğŸ“ åœ°å€" onblur="autoConvertGeo('add')">
                <button class="btn-map-convert" onclick="openPinPicker('add')">
                    <svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                </button>
                <input type="text" id="add-geo" class="sunken-input" style="flex:2;" readonly placeholder="åº§æ¨™">
                <span id="add-geo-status" style="display:none; position:absolute;">âœ…</span>
            </div>
        </div>

        <div class="input-group">
            <span class="input-label">åƒè€ƒç¶²å€</span>
            <input type="text" id="add-ref-url" class="sunken-input" placeholder="ç›¸é—œç¶²é é€£çµ">
        </div>
        
        <div class="input-group">
            <span class="input-label">ç‰¹é»å‚™è¨»</span>
            <input type="text" id="add-feature" class="sunken-input" placeholder="ä¾‹å¦‚ï¼šå¿…åƒã€CPå€¼é«˜" maxlength="20">
        </div>

        <div class="input-group">
            <span class="input-label">è©³ç´°èªªæ˜</span>
            <textarea id="add-desc" class="sunken-input" rows="3" placeholder="å‚™è¨»" style="height:auto; min-height:60px; padding-top:10px;"></textarea>
        </div>

        <div class="action-row">
            <button class="convex-btn action-btn-add" onclick="executeAdd()">æ–° å¢</button>
            <button class="convex-btn action-btn-reset" onclick="resetForm('add')">é‡ç½®</button>
            <button class="convex-btn action-btn-logout btn-danger-style" onclick="handleLogout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="filter-wrapper">
        <div class="filter-top-row">
            <input type="text" id="filter-keyword" class="filter-search-box" placeholder="æœå°‹" oninput="applyFilter()">
            <button class="filter-reset-btn btn-danger-style" onclick="resetFilter()">â†º</button>
        </div>
        
        <div class="filter-select-container">
            <select id="filter-category" class="filter-select" onchange="applyFilter()">
                <option value="">æ‰€æœ‰é¡åˆ¥</option>
            </select>
            <select id="filter-country" class="filter-select" onchange="applyFilter()">
                <option value="">æ‰€æœ‰åœ‹å®¶</option>
            </select>
            <select id="filter-city" class="filter-select" onchange="applyFilter()">
                <option value="">æ‰€æœ‰éƒ½å¸‚</option>
            </select>
            <select id="filter-platform" class="filter-select" onchange="applyFilter()">
                <option value="">æ‰€æœ‰å¹³å°</option>
            </select>
        </div>
    </div>

    <div id="card-area" class="grid-container">
        <p style="text-align:center; width:100%; color:#999; margin-top:20px;">è¼‰å…¥ä¸­...</p>
    </div>


    <div id="section-edit" class="panel-container hidden">
        <input type="hidden" id="edit-id">
        
        <div class="search-container">
            <div style="display:flex; gap:10px;">
                <input type="text" id="edit-link-fetch" class="sunken-input" placeholder="ğŸ”— ç¶²å€æŠ“å–">
                <button class="convex-btn btn-fetch" style="width:80px;" onclick="autoFetch('edit')">æŠ“å–</button>
            </div>
        </div>

        <div class="category-group">
            <button class="convex-btn cat-btn-layout cat-btn-edit" onclick="selectCategory('edit', 'è³¼ç‰©', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z'%3E%3C/path%3E%3Cline x1='3' y1='6' x2='21' y2='6'%3E%3C/line%3E%3Cpath d='M16 10a4 4 0 0 1-8 0'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">è³¼ç‰©</span>
            </button>
            <button class="convex-btn cat-btn-layout cat-btn-edit" onclick="selectCategory('edit', 'é¤å»³', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'%3E%3C/path%3E%3Cpath d='M7 2v20'%3E%3C/path%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">é¤å»³</span>
            </button>
            <button class="convex-btn cat-btn-layout cat-btn-edit" onclick="selectCategory('edit', 'æ™¯é»', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='2' y1='12' x2='22' y2='12'%3E%3C/line%3E%3Cpath d='M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">æ™¯é»</span>
            </button>
            <button class="convex-btn cat-btn-layout cat-btn-edit" onclick="selectCategory('edit', 'æ—…é¤¨', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 22h20'%3E%3C/path%3E%3Cpath d='M4 22V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v18'%3E%3C/path%3E%3Cpath d='M12 18v4'%3E%3C/path%3E%3Cpath d='M8 6h.01'%3E%3C/path%3E%3Cpath d='M16 6h.01'%3E%3C/path%3E%3Cpath d='M8 10h.01'%3E%3C/path%3E%3Cpath d='M16 10h.01'%3E%3C/path%3E%3Cpath d='M8 14h.01'%3E%3C/path%3E%3Cpath d='M16 14h.01'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">æ—…é¤¨</span>
            </button>
            <button class="convex-btn cat-btn-layout cat-btn-edit" onclick="selectCategory('edit', 'å…¶ä»–', this)">
                <img class="cat-icon" src="data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'%3E%3C/path%3E%3C/svg%3E">
                <span class="cat-text">å…¶ä»–</span>
            </button>
        </div>
        <input type="hidden" id="edit-category" value="è³¼ç‰©">

        <div class="input-group">
            <span class="input-label">ä¸»é¡Œåç¨±</span>
            <input type="text" id="edit-title" class="sunken-input" placeholder="åç¨±" maxlength="25">
        </div>

        <div class="input-group">
            <span class="input-label">åœ–ç‰‡ç¶²å€</span>
            <input type="text" id="edit-img" class="sunken-input" placeholder="é€£çµ" oninput="updatePreview('edit')">
            <div id="box-preview-edit" class="img-preview-box">
                <img id="preview-edit" src="" class="img-preview-content">
            </div>
        </div>

        <div class="input-row-multi">
            <div class="input-group" style="width: 30%;">
                <span class="input-label">åœ‹å®¶</span>
                <input type="text" id="edit-country" class="sunken-input" placeholder="" maxlength="10">
            </div>
            <div class="input-group" style="width: 30%;">
                <span class="input-label">éƒ½å¸‚</span>
                <input type="text" id="edit-city" class="sunken-input" placeholder="" maxlength="10">
            </div>
            <div class="input-group" style="width: 40%;">
                <span class="input-label">å¹³å°</span>
                <div class="platform-wrapper">
                    <select id="edit-platform" class="sunken-input platform-select" onchange="toggleOtherInput('edit')">
                        <option value="">(ç„¡)</option>
                        <option value="å®˜ç¶²">å®˜ç¶²</option>
                        <option value="å¯¦é«”">å¯¦é«”</option>
                        <option value="è¦çš®">è¦çš®</option>
                        <option value="momo">momo</option>
                        <option value="æ·˜å¯¶">æ·˜å¯¶</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <input type="text" id="edit-platform-other" class="sunken-input platform-other" placeholder="è¼¸å…¥" maxlength="5">
                </div>
            </div>
        </div>
        
        <div class="input-group">
            <span class="input-label">è©³ç´°åœ°å€ / åº§æ¨™</span>
            <div style="display:flex; gap:5px; width:100%;">
                <input type="text" id="edit-loc" class="sunken-input" style="flex:3;" placeholder="ğŸ“ åœ°å€" onblur="autoConvertGeo('edit')">
                <button class="btn-map-convert" onclick="openPinPicker('edit')">
                    <svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                </button>
                <input type="text" id="edit-geo" class="sunken-input" style="flex:2;" readonly placeholder="åº§æ¨™">
            </div>
        </div>

        <div class="input-group">
            <span class="input-label">åƒè€ƒç¶²å€</span>
            <input type="text" id="edit-ref-url" class="sunken-input" placeholder="é€£çµ">
        </div>

        <div class="input-group">
            <span class="input-label">ç‰¹é»å‚™è¨»</span>
            <input type="text" id="edit-feature" class="sunken-input" placeholder="ç‰¹é»" maxlength="20">
        </div>

        <div class="input-group">
            <span class="input-label">è©³ç´°èªªæ˜</span>
            <textarea id="edit-desc" class="sunken-input" rows="3" placeholder="å‚™è¨»" style="height:auto; min-height:60px; padding-top:10px;"></textarea>
        </div>

        <div class="action-row">
            <button class="convex-btn action-btn-add" onclick="executeUpdate()">ç¢ºèªä¿®æ”¹</button>
            <button class="convex-btn action-btn-reset" onclick="switchToAddMode()">å–æ¶ˆ</button>
            <button class="convex-btn action-btn-logout btn-danger-style" onclick="handleLogout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="fab-container">
        <button class="fab-btn" onclick="showMap()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
        </button>
        <button class="fab-btn hidden" id="go-top-btn" onclick="scrollToTop()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>
        </button>
    </div>

    <div id="map-overlay">
        <div id="map-header">
            <h3 style="margin:0; color:var(--text-main);">ğŸ“ æ”¶è—åœ°åœ–</h3>
            <button class="convex-btn btn-danger-style" onclick="closeMap()">âŒ é—œé–‰</button>
        </div>
        <button id="btn-filter-area" onclick="filterByMapBounds()">ğŸ¯ ç¯©é¸æ­¤å€åŸŸ</button>
        <div id="map-loading">ğŸ” æ­£åœ¨å•Ÿå‹•åœ°åœ–å¼•æ“...</div>
        <div id="full-map"></div>
    </div>
    
    <div id="picker-overlay">
        <div id="picker-container">
            <div id="picker-map"></div>
            <div id="picker-controls">
                <p style="font-size:12px; margin:0 0 10px 0; color:#333;">é»æ“Šåœ°åœ–é¸æ“‡ä½ç½®ï¼Œæˆ–æœå°‹åœ°å€</p>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="picker-search" class="sunken-input" placeholder="è¼¸å…¥åœ°å€æœå°‹...">
                    <button class="convex-btn" onclick="searchInPicker()">ğŸ”</button>
                </div>
                <button class="convex-btn action-btn-add" onclick="confirmPicker()">âœ… ç¢ºèªåº§æ¨™</button>
                <button class="convex-btn" style="background:#eee; margin-top:5px;" onclick="closePicker()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://ocrbkyclrhhnyvzosbyc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jcmJreWNscmhobnl2em9zYnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNzgyMjksImV4cCI6MjA4Mzg1NDIyOX0.DB44xf_i3WMyjpek2nQk5oo9MyzTYNsDCqiExmpMOgA';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let allItems = []; 
        let filteredItems = [];
        let map = null; 
        let markersCluster = null; 
        let currentMarkers = []; 
        let pickerMap = null;
        let pickerMarker = null;
        let currentPickerMode = 'add';

        const svgIcons = {
            'è³¼ç‰©': "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z'%3E%3C/path%3E%3Cline x1='3' y1='6' x2='21' y2='6'%3E%3C/line%3E%3Cpath d='M16 10a4 4 0 0 1-8 0'%3E%3C/path%3E%3C/svg%3E",
            'é¤å»³': "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2'%3E%3C/path%3E%3Cpath d='M7 2v20'%3E%3C/path%3E%3Cpath d='M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7'%3E%3C/path%3E%3C/svg%3E",
            'æ™¯é»': "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='2' y1='12' x2='22' y2='12'%3E%3C/line%3E%3Cpath d='M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z'%3E%3C/path%3E%3C/svg%3E",
            'æ—…é¤¨': "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 22h20'%3E%3C/path%3E%3Cpath d='M4 22V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v18'%3E%3C/path%3E%3Cpath d='M12 18v4'%3E%3C/path%3E%3Cpath d='M8 6h.01'%3E%3C/path%3E%3Cpath d='M16 6h.01'%3E%3C/path%3E%3Cpath d='M8 10h.01'%3E%3C/path%3E%3Cpath d='M16 10h.01'%3E%3C/path%3E%3Cpath d='M8 14h.01'%3E%3C/path%3E%3Cpath d='M16 14h.01'%3E%3C/path%3E%3C/svg%3E",
            'å…¶ä»–': "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237A90A4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'%3E%3C/path%3E%3C/svg%3E"
        };

        // --- AUTH LOGIC ---
        async function checkUser() {
            const { data: { user } } = await db.auth.getUser();
            if (user) {
                currentUser = user;
                document.getElementById('auth-overlay').style.display = 'none';
                fetchItems();
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
        }

        async function handleLogin() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-pwd').value;
            const msg = document.getElementById('auth-msg');

            if(!username || !password) return msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼";
            msg.innerText = "ç™»å…¥ä¸­...";
            
            const fakeEmail = `${username}@wishlist.app`;

            const { data, error } = await db.auth.signInWithPassword({ email: fakeEmail, password });
            if (error) {
                if(error.message.includes("Invalid login")) msg.innerText = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
                else msg.innerText = "ç™»å…¥å¤±æ•—: " + error.message;
            } else {
                location.reload();
            }
        }

        async function handleSignup() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-pwd').value;
            const msg = document.getElementById('auth-msg');
            
            const userRegex = /^[a-zA-Z0-9]{5,10}$/;
            if(!userRegex.test(username)) {
                return msg.innerText = "å¸³è™Ÿé™ 5~10 ä½è‹±æ–‡æˆ–æ•¸å­—";
            }
            
            if(password.length < 6) return msg.innerText = "å¯†ç¢¼è‡³å°‘éœ€6ä½æ•¸";
            msg.innerText = "è¨»å†Šä¸­...";

            const fakeEmail = `${username}@wishlist.app`;

            const { data, error } = await db.auth.signUp({ email: fakeEmail, password });
            if (error) {
                if(error.message.includes("already registered")) msg.innerText = "æ­¤å¸³è™Ÿå·²è¢«è¨»å†Š";
                else msg.innerText = "è¨»å†Šå¤±æ•—: " + error.message;
            } else {
                msg.style.color = 'green';
                msg.innerText = "è¨»å†ŠæˆåŠŸï¼";
                if(data.user) location.reload();
            }
        }

        async function handleLogout() {
            await db.auth.signOut();
            location.reload();
        }

        window.onload = checkUser;

        // --- MAIN LOGIC ---
        window.onscroll = function() {
            const btn = document.getElementById('go-top-btn');
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        };

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleOtherInput(mode) {
            const select = document.getElementById(`${mode}-platform`);
            const otherInput = document.getElementById(`${mode}-platform-other`);
            if(select.value === 'å…¶ä»–') {
                otherInput.classList.add('show');
            } else {
                otherInput.classList.remove('show');
            }
        }

        function selectCategory(mode, value, btnElement) {
            document.getElementById(`${mode}-category`).value = value;
            document.querySelectorAll(`.cat-btn-${mode}`).forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
        }

        function switchToAddMode() {
            document.getElementById('section-add').classList.remove('hidden');
            document.getElementById('section-edit').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm(mode) {
            if(mode === 'add') {
                document.getElementById('add-link-fetch').value = ''; 
                document.getElementById('add-title').value = '';
                document.getElementById('add-feature').value = '';
                document.getElementById('add-img').value = '';
                document.getElementById('add-country').value = '';
                document.getElementById('add-city').value = '';
                document.getElementById('add-platform').value = '';
                document.getElementById('add-platform-other').value = '';
                document.getElementById('add-platform-other').classList.remove('show');
                document.getElementById('add-loc').value = '';
                document.getElementById('add-geo').value = '';
                document.getElementById('add-ref-url').value = '';
                document.getElementById('add-desc').value = '';
                document.getElementById('add-geo-status').style.display = 'none';
                updatePreview('add');
                selectCategory('add', 'è³¼ç‰©', document.querySelector('.cat-btn-add'));
            }
        }

        // --- SMART GEO (æ–·å°¾æ±‚ç”Ÿç‰ˆ) ---
        async function autoConvertGeo(mode) {
            const addrInput = document.getElementById(`${mode}-loc`);
            const countryField = document.getElementById(`${mode}-country`);
            const cityField = document.getElementById(`${mode}-city`);
            const geoField = document.getElementById(`${mode}-geo`);
            
            const rawAddr = addrInput.value.trim();
            if(!rawAddr) return; 

            if(!countryField.value) {
                if(rawAddr.match(/å°ç£|å°åŒ—|æ–°åŒ—|æ¡ƒåœ’|å°ä¸­|å°å—|é«˜é›„|åŸºéš†|æ–°ç«¹|å˜‰ç¾©|å®œè˜­|èŠ±è“®|å°æ±|è‹—æ —|å½°åŒ–|å—æŠ•|é›²æ—|å±æ±|æ¾æ¹–|é‡‘é–€|é€£æ±Ÿ/)) {
                    countryField.value = 'å°ç£';
                }
            }
            if(!cityField.value) {
                 const cityMatch = rawAddr.match(/(\S{2,3}[ç¸£å¸‚])/);
                 if(cityMatch) cityField.value = cityMatch[1];
            }

            if(geoField.value) return; 

            const queryOSM = async (queryString) => {
                try {
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(queryString)}&limit=1&addressdetails=1&accept-language=zh-TW`;
                    const res = await fetch(url);
                    const data = await res.json();
                    return (data && data.length > 0) ? data[0] : null;
                } catch(e) { return null; }
            };

            geoField.placeholder = "ğŸ”...";
            
            let cleanAddr = rawAddr.replace(/^\d{3,5}\s*/, '');
            let baseQuery = cleanAddr;
            const currentCountry = countryField.value || "";
            const currentCity = cityField.value || "";
            if(currentCountry && !baseQuery.includes(currentCountry)) baseQuery = currentCountry + " " + baseQuery;

            let result = null;
            result = await queryOSM(baseQuery); // Round 1

            if(!result) { // Round 2 (æ–·å°¾)
                let stripAddr = cleanAddr;
                const numMatch = stripAddr.match(/(.*?(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)(è™Ÿ|å·))/);
                if(numMatch) {
                    let query2 = numMatch[1];
                    if(currentCountry && !query2.includes(currentCountry)) query2 = currentCountry + " " + query2;
                    result = await queryOSM(query2);
                }
            }

            if(!result) { // Round 3 (åªæœè·¯å)
                const roadMatch = cleanAddr.match(/.*?[è·¯è¡—é“](?:\d+æ®µ)?/);
                if(roadMatch) {
                    let query3 = roadMatch[0];
                    if(currentCountry && !query3.includes(currentCountry)) query3 = currentCountry + " " + query3;
                    if(currentCity && !query3.includes(currentCity)) query3 = currentCity + " " + query3;
                    result = await queryOSM(query3);
                }
            }

            if(result) {
                geoField.value = `${parseFloat(result.lat).toFixed(6)},${parseFloat(result.lon).toFixed(6)}`;
                document.getElementById(`${mode}-geo-status`).style.display = 'block';
                const details = result.address;
                if(!countryField.value && details.country) countryField.value = details.country;
                if(!cityField.value) {
                    let apiCity = details.city || details.town || details.village || details.county || details.state || "";
                    if(details.city) apiCity = details.city; 
                    if(apiCity) cityField.value = apiCity;
                }
            } else {
                geoField.placeholder = "âŒ";
            }
        }

        function triggerEdit(id) {
            const item = allItems.find(i => i.id == id);
            if (!item) return alert('è®€å–è³‡æ–™éŒ¯èª¤');
            
            document.getElementById('section-add').classList.add('hidden');
            document.getElementById('section-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-img').value = item.image_url;
            document.getElementById('edit-loc').value = item.location;
            
            let desc = item.description || "";
            let refUrl = "", country = "", city = "", feature = "", platform = "", geo = "";
            
            const refMatch = desc.match(/\n?\[Ref:(.*?)\]/);
            if (refMatch) { refUrl = refMatch[1]; desc = desc.replace(refMatch[0], ""); }
            else if(item.location && item.location.startsWith('http')) { refUrl = item.location; }

            const countryMatch = desc.match(/\n?\[Country:(.*?)\]/);
            if (countryMatch) { country = countryMatch[1]; desc = desc.replace(countryMatch[0], ""); }

            const cityMatch = desc.match(/\n?\[City:(.*?)\]/);
            if (cityMatch) { city = cityMatch[1]; desc = desc.replace(cityMatch[0], ""); }
            
            const featMatch = desc.match(/\n?\[Feat:(.*?)\]/);
            if (featMatch) { feature = featMatch[1]; desc = desc.replace(featMatch[0], ""); }

            const platMatch = desc.match(/\n?\[Plat:(.*?)\]/);
            if (platMatch) { platform = platMatch[1]; desc = desc.replace(platMatch[0], ""); }
            
            const geoMatch = desc.match(/\n?\[Geo:(.*?)\]/);
            if (geoMatch) { geo = geoMatch[1]; desc = desc.replace(geoMatch[0], ""); }

            document.getElementById('edit-link-fetch').value = ""; 
            document.getElementById('edit-country').value = country;
            document.getElementById('edit-city').value = city;
            document.getElementById('edit-feature').value = feature;
            document.getElementById('edit-ref-url').value = refUrl;
            document.getElementById('edit-desc').value = desc.trim();
            document.getElementById('edit-geo').value = geo;
            
            if(geo) document.getElementById('edit-geo-status').style.display = 'block';
            else document.getElementById('edit-geo-status').style.display = 'none';

            const platformSelect = document.getElementById('edit-platform');
            const standardPlatforms = ["å®˜ç¶²", "å¯¦é«”", "è¦çš®", "momo", "æ·˜å¯¶"];
            
            if(platform) {
                if(standardPlatforms.includes(platform)) {
                    platformSelect.value = platform;
                    toggleOtherInput('edit');
                } else {
                    platformSelect.value = 'å…¶ä»–';
                    toggleOtherInput('edit');
                    document.getElementById('edit-platform-other').value = platform;
                }
            } else {
                platformSelect.value = "";
                toggleOtherInput('edit');
            }

            updatePreview('edit');

            const catButtons = document.querySelectorAll('.cat-btn-edit');
            catButtons.forEach(btn => {
                if(btn.innerText.includes(item.category)) {
                    selectCategory('edit', item.category, btn);
                }
            });
        }

        function updatePreview(mode) {
            const url = document.getElementById(`${mode}-img`).value;
            const img = document.getElementById(`preview-${mode}`);
            const box = document.getElementById(`box-preview-${mode}`);
            if(url) {
                img.src = url;
                box.classList.add('has-img');
            } else {
                img.src = "";
                box.classList.remove('has-img');
            }
        }

        function openMapDirect(loc, city) {
            const fullLoc = city + " " + loc;
            if(loc || city) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullLoc)}`, '_blank');
            else alert('ç„¡åœ°å€è³‡æ–™');
        }

        function bundleDescription(desc, ref, country, city, feature, platform, geo) {
            let finalDesc = desc;
            if(country) finalDesc += `\n[Country:${country}]`;
            if(city) finalDesc += `\n[City:${city}]`;
            if(ref) finalDesc += `\n[Ref:${ref}]`;
            if(feature) finalDesc += `\n[Feat:${feature}]`;
            if(platform) finalDesc += `\n[Plat:${platform}]`;
            if(geo) finalDesc += `\n[Geo:${geo}]`;
            return finalDesc;
        }

        async function executeAdd() {
            if(!currentUser) return alert('è«‹å…ˆç™»å…¥');
            const title = document.getElementById('add-title').value;
            const image = document.getElementById('add-img').value;
            const category = document.getElementById('add-category').value;
            let desc = document.getElementById('add-desc').value;
            const loc = document.getElementById('add-loc').value;
            const country = document.getElementById('add-country').value;
            const city = document.getElementById('add-city').value;
            const ref = document.getElementById('add-ref-url').value;
            const feature = document.getElementById('add-feature').value;
            const geo = document.getElementById('add-geo').value;
            
            let platform = document.getElementById('add-platform').value;
            if(platform === 'å…¶ä»–') platform = document.getElementById('add-platform-other').value;

            if (!title) return alert('è«‹è¼¸å…¥ä¸»é¡Œåç¨±');

            desc = bundleDescription(desc, ref, country, city, feature, platform, geo);

            const { error } = await db.from('products').insert([{ 
                title, image_url: image, category, description: desc, location: loc, user_id: currentUser.id 
            }]);

            if (error) alert('æ–°å¢å¤±æ•—ï¼š' + error.message);
            else {
                alert('âœ¨ å·²æ”¶è—ï¼');
                location.reload(); 
            }
        }

        async function executeUpdate() {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('edit-title').value;
            const image = document.getElementById('edit-img').value;
            const category = document.getElementById('edit-category').value;
            let desc = document.getElementById('edit-desc').value;
            const loc = document.getElementById('edit-loc').value;
            const country = document.getElementById('edit-country').value;
            const city = document.getElementById('edit-city').value;
            const ref = document.getElementById('edit-ref-url').value;
            const feature = document.getElementById('edit-feature').value;
            const geo = document.getElementById('edit-geo').value;
            
            let platform = document.getElementById('edit-platform').value;
            if(platform === 'å…¶ä»–') platform = document.getElementById('edit-platform-other').value;

            desc = bundleDescription(desc, ref, country, city, feature, platform, geo);

            const { error } = await db.from('products').update({ 
                title, image_url: image, category, description: desc, location: loc
            }).eq('id', id);

            if (error) alert('æ›´æ–°å¤±æ•—');
            else {
                alert('âœ¨ ä¿®æ”¹å®Œæˆ');
                switchToAddMode();
                fetchItems();
            }
        }

        async function deleteItem(id) {
            if(!confirm('ç¢ºå®šè¦ç§»é™¤é€™å€‹æ”¶è—å—ï¼Ÿ')) return;
            const { error } = await db.from('products').delete().eq('id', id);
            if (!error) fetchItems();
        }

        async function fetchItems() {
            const { data, error } = await db.from('products').select('*').order('created_at', { ascending: false });
            if (error) return console.error(error);

            allItems = data.map(item => {
                let desc = item.description || "";
                let country = "", city = "", refUrl = "", feature = "", platform = "", geo = "";
                
                const cMatch = desc.match(/\n?\[Country:(.*?)\]/);
                if(cMatch) { country = cMatch[1]; desc = desc.replace(cMatch[0], ""); }
                
                const cityMatch = desc.match(/\n?\[City:(.*?)\]/);
                if(cityMatch) { city = cityMatch[1]; desc = desc.replace(cityMatch[0], ""); }

                const refMatch = desc.match(/\n?\[Ref:(.*?)\]/);
                if(refMatch) { refUrl = refMatch[1]; desc = desc.replace(refMatch[0], ""); }
                else if(item.location && item.location.startsWith('http')) { refUrl = item.location; }

                const featMatch = desc.match(/\n?\[Feat:(.*?)\]/);
                if(featMatch) { feature = featMatch[1]; desc = desc.replace(featMatch[0], ""); }

                const platMatch = desc.match(/\n?\[Plat:(.*?)\]/);
                if(platMatch) { platform = platMatch[1]; desc = desc.replace(platMatch[0], ""); }
                
                const geoMatch = desc.match(/\n?\[Geo:(.*?)\]/);
                if (geoMatch) { geo = geoMatch[1]; desc = desc.replace(geoMatch[0], ""); }

                return { ...item, cleanDesc: desc, country, city, refUrl, feature, platform, geo };
            });

            populateFilterOptions();
            applyFilter(); 
        }

        function populateFilterOptions() {
            const cats = new Set(), countries = new Set(), cities = new Set(), plats = new Set();
            allItems.forEach(i => {
                if(i.category) cats.add(i.category);
                if(i.country && i.country !== 'null' && i.country !== '-') countries.add(i.country);
                if(i.city && i.city !== 'null' && i.city !== '-') cities.add(i.city);
                if(i.platform) plats.add(i.platform);
            });

            fillSelect('filter-category', cats, 'æ‰€æœ‰é¡åˆ¥');
            fillSelect('filter-country', countries, 'æ‰€æœ‰åœ‹å®¶');
            fillSelect('filter-city', cities, 'æ‰€æœ‰éƒ½å¸‚');
            fillSelect('filter-platform', plats, 'æ‰€æœ‰å¹³å°');
        }

        function fillSelect(id, set, defaultText) {
            const sel = document.getElementById(id);
            sel.innerHTML = `<option value="">${defaultText}</option>`;
            set.forEach(val => {
                sel.innerHTML += `<option value="${val}">${val}</option>`;
            });
        }

        function applyFilter() {
            const cat = document.getElementById('filter-category').value;
            const country = document.getElementById('filter-country').value;
            const city = document.getElementById('filter-city').value;
            const plat = document.getElementById('filter-platform').value;
            const keyword = document.getElementById('filter-keyword').value.toLowerCase();

            filteredItems = allItems.filter(item => {
                const matchKeyword = !keyword || 
                                     (item.title && item.title.toLowerCase().includes(keyword)) || 
                                     (item.cleanDesc && item.cleanDesc.toLowerCase().includes(keyword)) ||
                                     (item.feature && item.feature.toLowerCase().includes(keyword));

                return matchKeyword &&
                       (!cat || item.category === cat) &&
                       (!country || item.country === country) &&
                       (!city || item.city === city) &&
                       (!plat || item.platform === plat);
            });

            renderCards(filteredItems);
        }

        function resetFilter() {
            document.getElementById('filter-keyword').value = "";
            document.getElementById('filter-category').value = "";
            document.getElementById('filter-country').value = "";
            document.getElementById('filter-city').value = "";
            document.getElementById('filter-platform').value = "";
            applyFilter();
        }

        function renderCards(items) {
            const container = document.getElementById('card-area');
            container.innerHTML = ''; 
            
            if(items.length === 0) {
                 container.innerHTML = '<p style="text-align:center; width:100%; color:#5F6F6E;">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™ (æˆ–å°šæœªæ–°å¢)</p>';
                 return;
            }

            items.forEach(item => {
                const imgUrl = item.image_url;
                const safeTitle = escapeHtml(item.title);
                const safeLoc = escapeHtml(item.location || '');
                const linkUrl = item.refUrl || "#";
                const safeFeat = escapeHtml(item.feature || '');

                let imgContent = '';
                if(imgUrl) {
                    imgContent = `<img src="${imgUrl}" class="card-img" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'no-img-box\\'>ç„¡åœ–ç‰‡</div>'">`;
                } else {
                    imgContent = `<div class="no-img-box">ç„¡åœ–ç‰‡</div>`; 
                }

                let metaHtml = '<div class="card-meta-row">';
                metaHtml += `<div class="meta-box">${item.category}</div>`;
                if (item.country && item.country !== '-') metaHtml += `<div class="meta-box">${item.country}</div>`;
                if (item.city && item.city !== '-') metaHtml += `<div class="meta-box">${item.city}</div>`;
                if (item.platform && item.platform !== '-') metaHtml += `<div class="meta-box">${item.platform}</div>`;
                metaHtml += '</div>';

                const html = `
                    <div class="card">
                        <a href="${linkUrl}" target="_blank" class="card-img-wrapper">
                            ${imgContent}
                        </a>
                        
                        <div class="card-body">
                            ${metaHtml}

                            <div class="card-title">${safeTitle}</div>
                            ${safeFeat ? `<div class="card-feature">âœ¨ ${safeFeat}</div>` : ''}

                            <div class="card-btn-row">
                                <button class="btn-mini btn-map" onclick="openMapDirect('${safeLoc}', '${item.city}')">
                                    <svg class="btn-map-icon" viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
                                </button>
                                <button class="btn-mini btn-edit" onclick="triggerEdit('${item.id}')">ç·¨è¼¯</button>
                                <button class="btn-mini btn-del" onclick="deleteItem('${item.id}')">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/'/g, "\\'").replace(/"/g, '"');
        }

        async function autoFetch(mode) {
            const url = document.getElementById(`${mode}-link-fetch`).value;
            if (!url) return alert('è«‹å…ˆè²¼ä¸Šç¶²å€ï¼');
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "...";

            try {
                const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}&palette=true`);
                const json = await response.json();
                
                if (json.status === 'success') {
                    const data = json.data;
                    let title = data.title || '';
                    if(title.includes('Google Maps')) title = ""; 
                    if(title.length > 25) title = title.substring(0, 25);
                    
                    document.getElementById(`${mode}-title`).value = title;
                    document.getElementById(`${mode}-desc`).value = data.description || '';
                    document.getElementById(`${mode}-ref-url`).value = url; 
                    
                    if (data.image && data.image.url) {
                        document.getElementById(`${mode}-img`).value = data.image.url;
                        updatePreview(mode);
                    } else if (data.logo && data.logo.url) {
                        document.getElementById(`${mode}-img`).value = data.logo.url;
                        updatePreview(mode);
                    }
                } else {
                    alert('ç„¡æ³•æŠ“å–ï¼Œè«‹ç¢ºèªç¶²å€');
                }
            } catch (err) { console.error(err); alert('æŠ“å–ç™¼ç”ŸéŒ¯èª¤'); }
            
            btn.innerText = originalText;
        }

        function addMarker(item, lat, lon) {
            const svgStr = svgIcons[item.category] || svgIcons['å…¶ä»–'];
            
            const myIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-pin">
                           <img src="${svgStr}" style="width:18px; height:18px; transform: rotate(45deg); filter: brightness(0) invert(1);">
                       </div>`,
                iconSize: [34, 34],
                iconAnchor: [17, 42],
                popupAnchor: [0, -35]
            });

            const marker = L.marker([lat, lon], {icon: myIcon});
            
            const popupContent = `
                <div style="text-align:center;">
                    ${item.image_url ? `<img src="${item.image_url}" class="popup-img" onclick="window.open('${item.refUrl || '#'}')">` : ''}
                    <div class="popup-title" style="color:black;">${item.title}</div>
                    ${item.feature ? `<div class="popup-feature">âœ¨ ${item.feature}</div>` : ''}
                    <div class="popup-desc">${item.category}</div>
                    <button class="convex-btn" style="margin-top:5px; padding:5px; width:100%; font-size:10px; height:30px;" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location || item.title)}')">ğŸš— å°èˆª</button>
                </div>
            `;
            marker.bindPopup(popupContent);
            markersCluster.addLayer(marker);
            currentMarkers.push({ id: item.id, layer: marker });
        }
    </script>
</body>
</html>
